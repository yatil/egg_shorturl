# egg_shorturl 0.3
# Helpers for short URLs
# Eric Eggert
# http://yatil.de

# .....................................................................
# This is a plugin for Textpattern - http://textpattern.com/
# To install: textpattern > admin > plugins
# Paste the following text into the 'Install plugin' box:
# .....................................................................

YTo5OntzOjQ6Im5hbWUiO3M6MTI6ImVnZ19zaG9ydHVybCI7czo2OiJhdXRob3IiO3M6MTE6IkVyaWMgRWdnZXJ0IjtzOjEwOiJhdXRob3JfdXJpIjtzOjE1OiJodHRwOi8veWF0aWwuZGUiO3M6NzoidmVyc2lvbiI7czozOiIwLjMiO3M6MTE6ImRlc2NyaXB0aW9uIjtzOjIyOiJIZWxwZXJzIGZvciBzaG9ydCBVUkxzIjtzOjQ6ImhlbHAiO3M6MTM2ODoiPGgxPmVnZ19zaG9ydHVybDwvaDE+DQoNCgk8cD5UaGlzIHBsdWdpbiBuZWVkcyB0byBiZSB1c2VkIHdpdGggZm9sbG93aW5nIGxpbmVzIGluIHlvdXIgPGtiZD4uaHRhY2Nlc3M8L2tiZD4gZmlsZTo8L3A+DQo8cHJlPjxjb2RlPlJld3JpdGVFbmdpbmUgT24NClJld3JpdGVSdWxlIF4oXGQrKSQgaHR0cDovL2V4YW1wbGUuY29tL3MvJDEgW1I9MzAxLExdPC9jb2RlPjwvcHJlPg0KCTxwPih3aXRoIGV4YW1wbGUuY29tID0geW91ciBkb21haW4pPC9wPg0KCTxwPmFuZCBhIHNlY3Rpb24gPGNvZGU+czwvY29kZT4gd2l0aCB0aGUgZm9sbG93aW5nIHRlbXBsYXRlOjwvcD4NCjxwcmU+PGNvZGU+Jmx0O3R4cDplZ2dfc2hvcnR1cmxfaGFuZGxlciAvJmd0OzwvY29kZT48L3ByZT4NCgk8cD48c3Ryb25nPlRoaXMgcGx1Z2luIHdvcmtzIG9ubHkgd2l0aCB0aGUgPGNvZGU+L3NlY3Rpb24vdGl0bGU8L2NvZGU+IFVSTCBzY2hlbWEuPC9zdHJvbmc+PC9wPg0KDQoNCgk8aDI+SGVscGVyIGZ1bmN0aW9uczwvaDI+DQoJPGgzPiZsdDt0eHA6ZWdnX3Nob3J0dXJsX2xpbmsgLz48L2gzPg0KCTxwPk91dHB1dHMgYSBsaW5rIGVsZW1lbnQgZm9yIHRoZSBoZWFkZXIgYXJlYSBvZiB5b3VyIDxzcGFuIGNsYXNzPSJjYXBzIj5IVE1MPC9zcGFuPiBkb2N1bWVudC4gKEVtcHR5IG9uIGFydGljbGUgbGlzdCBkb2N1bWVudHMuKTwvcD4NCgk8aDM+Jmx0O3R4cDplZ2dfc2hvcnR1cmxfYSAvPjwvaDM+DQoJPHA+T3V0cHV0cyBhIG5vcm1hbCBhIGhyZWYgZWxlbWVudCB0byB1c2UgaW4gYXJ0aWNsZSBjb250ZXh0IChlZy4gaW4geW91ciBkZWZhdWx0IGZvcm0pLjwvcD4NCgk8aDM+Jmx0O3R4cDplZ2dfc2hvcnR1cmxfdHdlZXQgLz48L2gzPg0KCTxwPk91dHB1dHMgYSBsaW5rIHRvIHR3aXR0ZXIgZmlsbGluZyB0aGUgdGV4dGJveCB3aXRoIHRoZSB0aXRsZSBhbmQgYSBsaW5rIHRvIHlvdXIgYXJ0aWNsZS4gUGFyYW1ldGVyczo8L3A+DQo8dWw+DQoJPGxpPjxjb2RlPmNsYXNzPC9jb2RlPiA9IDxzcGFuIGNsYXNzPSJjYXBzIj5DU1M8L3NwYW4+IGNsYXNzLCBkZWZhdWx0cyB0byA8Y29kZT50d2VldG1lPC9jb2RlPjwvbGk+DQoJCTxsaT48Y29kZT50d2VldHByZTwvY29kZT4gPSBUZXh0IHByZWNlZGluZyB5b3VyIHR3ZWV0LCBkZWZhdWx0cyB0byA8Y29kZT5MZXNlIGdlcmFkZTo8L2NvZGU+IChlbjogPGNvZGU+Tm93IHJlYWRpbmc6PC9jb2RlPik8L2xpPg0KCQk8bGk+PGNvZGU+bGlua3RleHQ8L2NvZGU+ID0gVGV4dCBpbiB5b3VyIGEgZWxlbWVudCwgZGVmYXVsdHMgdG8gPGNvZGU+RGllc2VuIEFydGlrZWwgdHdpdHRlcm48L2NvZGU+IChlbjogPGNvZGU+VHdlZXQgdGhpcyBhcnRpY2xlPC9jb2RlPik8L2xpPg0KCTwvdWw+IjtzOjQ6ImNvZGUiO3M6MjI1MDoiIyA8P3BocCAvLyBUcmlja2luZyBUZXh0bWF0ZSBpbnRvIGRpc3BsYXlpbmcgc3ludGF4IGhpZ2hsaWdodGluZw0KDQpmdW5jdGlvbiBlZ2dfc2hvcnR1cmxfbGluaygpIHsNCglpZiAoaXNzZXQoJEdMT0JBTFNbJ3RoaXNhcnRpY2xlJ11bJ3RoaXNpZCddKSkgew0KCQlyZXR1cm4gJzxsaW5rIHJlbD0ic2hvcnR1cmwiIGhyZWY9Imh0dHA6Ly8nLiRHTE9CQUxTWydwcmVmcyddWydzaXRldXJsJ10uJEdMT0JBTFNbJ3ByZWZzJ11bJ3BhdGhfZnJvbV9yb290J10uJEdMT0JBTFNbJ3RoaXNhcnRpY2xlJ11bJ3RoaXNpZCddLiciIC8+JzsNCgl9DQp9DQoNCmZ1bmN0aW9uIGVnZ19zaG9ydHVybF9hKCkgew0KCXJldHVybiAnPGEgaHJlZj0iaHR0cDovLycuJEdMT0JBTFNbJ3ByZWZzJ11bJ3NpdGV1cmwnXS4kR0xPQkFMU1sncHJlZnMnXVsncGF0aF9mcm9tX3Jvb3QnXS4kR0xPQkFMU1sndGhpc2FydGljbGUnXVsndGhpc2lkJ10uJyIgcmVsPSJzaG9ydHVybCI+Jy4kR0xPQkFMU1sncHJlZnMnXVsnc2l0ZXVybCddLiRHTE9CQUxTWydwcmVmcyddWydwYXRoX2Zyb21fcm9vdCddLiRHTE9CQUxTWyd0aGlzYXJ0aWNsZSddWyd0aGlzaWQnXS4nPC9hPic7DQp9DQoNCmZ1bmN0aW9uIGVnZ19zaG9ydHVybF90d2VldCgkYXR0cykgew0KDQoJaWYgKGlzX2FycmF5KCRhdHRzKSkgZXh0cmFjdCgkYXR0cyk7DQoNCgkkbGlua3RleHQgPSBpc3NldCgkbGlua3RleHQpID8gJGxpbmt0ZXh0IDogJ0RpZXNlbiBBcnRpa2VsIHR3aXR0ZXJuJzsNCgkkdHdlZXRwcmUgPSBpc3NldCgkdHdlZXRwcmUpID8gJHR3ZWV0cHJlIDogJ0xlc2UgZ2VyYWRlOic7IA0KCSRjbGFzcyA9IGlzc2V0KCRjbGFzcykgPyAkY2xhc3MgOiAndHdlZXRtZSc7IA0KCSRocmVmID0gJ2h0dHA6Ly8nLiRHTE9CQUxTWydwcmVmcyddWydzaXRldXJsJ10uJEdMT0JBTFNbJ3ByZWZzJ11bJ3BhdGhfZnJvbV9yb290J10uJEdMT0JBTFNbJ3RoaXNhcnRpY2xlJ11bJ3RoaXNpZCddOw0KDQoJJHRpdGxlID0gJEdMT0JBTFNbJ3RoaXNhcnRpY2xlJ11bJ3RpdGxlJ107DQoNCgkkdHdlZXRzcGFjZSA9IDE0MCAtIChzdHJsZW4oJHR3ZWV0cHJlKSArIHN0cmxlbigkaHJlZikgKyAyKTsNCg0KCS8qIFRoaXMgcGFydCB0cmltcyB0aGUgdGl0bGUgKi8NCgkvKiBCeSBAdG9zY2hvIC0gc2VlIGh0dHA6Ly90b3NjaG8uZGUvMjAwOS9waHAtZnVua3Rpb24tZW5kX29uX3dvcmQvICovDQoNCglpZihzdHJsZW4oJHRpdGxlKSA+ICR0d2VldHNwYWNlKXsNCgkJJHRpdGxlID0gc3Vic3RyKCR0aXRsZSwgMCwgJHR3ZWV0c3BhY2UpOw0KCQkkYXJyICAgPSBleHBsb2RlKCcgJywgdHJpbSgkdGl0bGUpICk7DQoJCWFycmF5X3BvcCgkYXJyKTsNCgkJJHRpdGxlID0gcnRyaW0oIGltcGxvZGUoJyAnLCAkYXJyKSwgJyw7Jyk7DQoJCSR0aXRsZSA9ICR0aXRsZS4iPyI7DQoJfQ0KDQoJJG1lc3NhZ2UgPSAkdHdlZXRwcmUuIiAiLiR0aXRsZS4iICIuJGhyZWY7DQoNCglyZXR1cm4gJzxhIGhyZWY9Imh0dHA6Ly90d2l0dGVyLmNvbS9ob21lP3N0YXR1cz0nLnVybGVuY29kZSgkbWVzc2FnZSkuJyIgY2xhc3M9IicuJGNsYXNzLiciPicuJGxpbmt0ZXh0Lic8L2E+JzsNCg0KfQ0KDQpmdW5jdGlvbiBlZ2dfc2hvcnR1cmxfaGFuZGxlcigpIHsNCg0KCSRzdWJwYXRoID0gcHJlZ19yZXBsYWNlKCIvaHR0cHM/OlwvXC8uKihcLy4qKS9VaSIsIiQxIixodSk7DQoJJHJlZ3NhZmVzdWJwYXRoID0gcHJlZ19xdW90ZSgkc3VicGF0aCwgJy8nKTsNCgkkcmVxID0gcHJlZ19yZXBsYWNlKCIvXiRyZWdzYWZlc3VicGF0aC9pIiwnLycsJF9TRVJWRVJbJ1JFUVVFU1RfVVJJJ10pOw0KDQoJJHFzID0gc3RycG9zKCRyZXEsICc/Jyk7DQoJJHFhdHRzID0gKCRxcyA/ICcmJy5zdWJzdHIoJHJlcSwgJHFzICsgMSkgOiAnJyk7DQoJaWYgKCRxcykgJHJlcSA9IHN1YnN0cigkcmVxLCAwLCAkcXMpOw0KDQoJJHBhcnRzID0gYXJyYXlfdmFsdWVzKGFycmF5X2ZpbHRlcihzcGxpdCgnLycsICRyZXEpKSk7DQoJJHJzID0gc2FmZV9yb3coIlNlY3Rpb24sIHVybF90aXRsZSIsInRleHRwYXR0ZXJuIiwgImlkPSIuJHBhcnRzWzFdKTsNCgkNCglleHRyYWN0KCRycyk7DQoJDQoJJHVybCA9ICdodHRwOi8vJy4kR0xPQkFMU1sncHJlZnMnXVsnc2l0ZXVybCddLiRHTE9CQUxTWydwcmVmcyddWydwYXRoX2Zyb21fcm9vdCddLiRTZWN0aW9uLicvJy4kdXJsX3RpdGxlOw0KCQ0KCWhlYWRlcignTG9jYXRpb246ICcgLiAkdXJsKTsNCgl0eHBfZGllKCcnLCAnMzAxJyk7DQp9IjtzOjQ6InR5cGUiO3M6MToiMCI7czozOiJtZDUiO3M6MzI6IjE4NTE1OTdmYjE5NWY2NmEwZWI3YWQ0NmZmN2MzY2ZkIjt9